name: Release

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag (e.g., v0.1.0)'
        required: true
        type: string

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: pulseengine/loom

jobs:
  build-native:
    name: Build Native (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            artifact: loom-linux-x64
            binary: loom
          - os: macos-latest
            target: x86_64-apple-darwin
            artifact: loom-macos-x64
            binary: loom
          - os: macos-latest
            target: aarch64-apple-darwin
            artifact: loom-macos-arm64
            binary: loom
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            artifact: loom-windows-x64
            binary: loom.exe
    steps:
      - uses: actions/checkout@v5
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}
      - uses: Swatinem/rust-cache@v2
        with:
          key: release-${{ matrix.target }}

      - name: Build release binary
        run: cargo build --release --target ${{ matrix.target }}

      - name: Create artifact directory
        shell: bash
        run: |
          mkdir -p artifacts
          cp target/${{ matrix.target }}/release/${{ matrix.binary }} artifacts/
          cd artifacts
          if [ "${{ runner.os }}" = "Windows" ]; then
            7z a ../${{ matrix.artifact }}.zip ${{ matrix.binary }}
          else
            tar -czvf ../${{ matrix.artifact }}.tar.gz ${{ matrix.binary }}
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: |
            ${{ matrix.artifact }}.tar.gz
            ${{ matrix.artifact }}.zip

  build-wasm:
    name: Build WASM (wasm32-wasip2)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-wasip2
      - uses: Swatinem/rust-cache@v2
        with:
          key: release-wasm

      - name: Install wasi-sdk
        run: |
          WASI_SDK_VERSION=25
          wget -q https://github.com/WebAssembly/wasi-sdk/releases/download/wasi-sdk-${WASI_SDK_VERSION}/wasi-sdk-${WASI_SDK_VERSION}.0-x86_64-linux.tar.gz -O wasi-sdk.tar.gz
          sudo mkdir -p /opt/wasi-sdk
          sudo tar -xzf wasi-sdk.tar.gz -C /opt/wasi-sdk --strip-components=1
          rm wasi-sdk.tar.gz

      - name: Build WASM binary
        env:
          WASI_SDK_PREFIX: /opt/wasi-sdk
        run: |
          cargo build --release --target wasm32-wasip2 --package loom-cli
          mkdir -p artifacts
          cp target/wasm32-wasip2/release/loom.wasm artifacts/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: loom-wasm
          path: artifacts/loom.wasm

  release:
    name: Create Release
    needs: [build-native, build-wasm]
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
      id-token: write  # For Cosign keyless signing

    steps:
      - uses: actions/checkout@v5

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release files
        run: |
          mkdir -p release

          # Move native binaries
          for dir in artifacts/loom-*; do
            if [ -d "$dir" ]; then
              name=$(basename "$dir")
              # Find the archive file (tar.gz or zip)
              archive=$(find "$dir" -name "*.tar.gz" -o -name "*.zip" | head -1)
              if [ -n "$archive" ]; then
                cp "$archive" release/
              fi
            fi
          done

          # Move WASM binary
          cp artifacts/loom-wasm/loom.wasm release/

          ls -la release/

      - name: Create SHA256 checksums
        run: |
          cd release
          for file in *; do
            sha256sum "$file" > "$file.sha256"
          done
          cat *.sha256

      - name: Install Cosign
        uses: sigstore/cosign-installer@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish OCI Artifact
        run: |
          # Install oras
          VERSION="1.2.2"
          curl -LO "https://github.com/oras-project/oras/releases/download/v${VERSION}/oras_${VERSION}_linux_amd64.tar.gz"
          mkdir -p oras-install/
          tar -zxf "oras_${VERSION}_linux_amd64.tar.gz" -C oras-install/
          sudo mv oras-install/oras /usr/local/bin/
          rm -rf "oras_${VERSION}_linux_amd64.tar.gz" oras-install/

          # Determine tag
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            TAG="${{ inputs.tag }}"
          else
            TAG="${{ github.event.release.tag_name }}"
          fi

          # Create OCI artifact references
          IMAGE_TAG="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${TAG}"
          IMAGE_LATEST="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest"

          # Push WASM file as OCI artifact
          echo "Publishing loom.wasm to OCI registry..."
          oras push "${IMAGE_TAG}" \
            --artifact-type application/vnd.wasm.component.layer.v1+wasm \
            release/loom.wasm:application/vnd.wasm.component.layer.v1+wasm

          # Tag as latest
          oras tag "${IMAGE_TAG}" latest

          echo "Published OCI artifacts:"
          echo "  ${IMAGE_TAG}"
          echo "  ${IMAGE_LATEST}"

          echo "IMAGE_TAG=${IMAGE_TAG}" >> $GITHUB_ENV
          echo "IMAGE_LATEST=${IMAGE_LATEST}" >> $GITHUB_ENV
          echo "RELEASE_TAG=${TAG}" >> $GITHUB_ENV

      - name: Sign OCI Artifact with Cosign
        run: |
          echo "Signing OCI artifact with Cosign (keyless)..."
          cosign sign --yes "${IMAGE_TAG}"
          cosign sign --yes "${IMAGE_LATEST}"
          echo "âœ… OCI artifact signed"

      - name: Generate SLSA Provenance
        run: |
          cat > provenance.json <<EOF
          {
            "buildType": "https://github.com/pulseengine/loom/release@v1",
            "builder": {
              "id": "https://github.com/actions/runner"
            },
            "invocation": {
              "configSource": {
                "uri": "${{ github.server_url }}/${{ github.repository }}",
                "digest": {
                  "sha1": "${{ github.sha }}"
                }
              }
            },
            "metadata": {
              "buildStartedOn": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
              "completeness": {
                "parameters": true,
                "environment": false,
                "materials": false
              }
            },
            "materials": [
              {
                "uri": "${{ github.server_url }}/${{ github.repository }}",
                "digest": {
                  "sha1": "${{ github.sha }}"
                }
              }
            ]
          }
          EOF

          cosign attest --yes \
            --predicate provenance.json \
            --type slsaprovenance \
            "${IMAGE_TAG}"

          echo "âœ… SLSA provenance attestation created"

      - name: Verify Signature
        run: |
          cosign verify \
            --certificate-identity-regexp="https://github.com/${{ github.repository }}" \
            --certificate-oidc-issuer="https://token.actions.githubusercontent.com" \
            "${IMAGE_TAG}" || echo "Note: Verification may require specific conditions"

          echo "âœ… Signature verification completed"

      - name: Upload Release Assets
        uses: softprops/action-gh-release@v2
        with:
          files: |
            release/*
          body: |
            ## ðŸŽ‰ LOOM WebAssembly Optimizer Release

            ### ðŸ“¦ Downloads

            **Native Binaries:**
            | Platform | Architecture | Download |
            |----------|--------------|----------|
            | Linux | x64 | `loom-linux-x64.tar.gz` |
            | macOS | x64 | `loom-macos-x64.tar.gz` |
            | macOS | ARM64 | `loom-macos-arm64.tar.gz` |
            | Windows | x64 | `loom-windows-x64.zip` |

            **WebAssembly:**
            - `loom.wasm` - WASI component (wasm32-wasip2)
            - OCI Artifact: `${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.RELEASE_TAG }}`

            ### ðŸ” Security

            - âœ… **OCI Signing** - Signed with Cosign (keyless GitHub OIDC)
            - âœ… **SLSA Provenance** - Build attestation included
            - âœ… **SHA256 Checksums** - All files have `.sha256` checksums

            ### ðŸš€ Quick Start

            ```bash
            # Linux/macOS
            tar -xzf loom-linux-x64.tar.gz
            ./loom optimize input.wasm -o output.wasm --stats

            # Or pull from OCI registry
            oras pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.RELEASE_TAG }}
            ```

            ### ðŸ” Verify

            ```bash
            # Verify checksum
            sha256sum -c loom-linux-x64.tar.gz.sha256

            # Verify OCI signature
            cosign verify \
              --certificate-identity-regexp="https://github.com/${{ github.repository }}" \
              --certificate-oidc-issuer="https://token.actions.githubusercontent.com" \
              ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.RELEASE_TAG }}

            # Verify SLSA provenance
            cosign verify-attestation \
              --type slsaprovenance \
              --certificate-identity-regexp="https://github.com/${{ github.repository }}" \
              --certificate-oidc-issuer="https://token.actions.githubusercontent.com" \
              ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.RELEASE_TAG }}
            ```

            ### ðŸ“š Documentation

            See [README.md](https://github.com/${{ github.repository }}) for usage details.
          tag_name: ${{ github.event_name == 'workflow_dispatch' && inputs.tag || github.event.release.tag_name }}

      - name: Create Release Summary
        run: |
          echo "## ðŸš€ Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Published Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Native Binaries:**" >> $GITHUB_STEP_SUMMARY
          echo "- \`loom-linux-x64.tar.gz\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`loom-macos-x64.tar.gz\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`loom-macos-arm64.tar.gz\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`loom-windows-x64.zip\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**WebAssembly:**" >> $GITHUB_STEP_SUMMARY
          echo "- \`loom.wasm\` ($(ls -lh release/loom.wasm | awk '{print $5}'))" >> $GITHUB_STEP_SUMMARY
          echo "- OCI: \`${IMAGE_TAG}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ” Security" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… OCI artifact signed with Cosign (keyless)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… SLSA provenance attestation" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… SHA256 checksums for all files" >> $GITHUB_STEP_SUMMARY
